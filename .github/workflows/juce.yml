name: JUCE CI

on:
  push:
  pull_request:

jobs:
  build:
    name: JUCE build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # macOS-13 images are headed for retirement; target macos-14 (Apple
        # silicon) where Xcode 15.x and the macOS 14 SDK remain available. We
        # still aim for a universal Mac build (arm64 + x86_64) so Intel users
        # aren't left out.
        os: [ubuntu-latest, macos-14, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clear any pre-checked-in build cache
        shell: bash
        run: cmake -E rm -rf plugins/build

      # macOS runners ship multiple Xcodes. Force a 15.x toolchain (with a
      # macOS 14 SDK tucked inside) before we start sniffing for the SDK.
      - name: Pin Xcode (macOS)
        if: matrix.os == 'macos-14'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.4"

      - name: Prep toolchain (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ninja-build \
            cmake \
            pkg-config \
            libasound2-dev \
            libcurl4-openssl-dev \
            libfreetype6-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libx11-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev

      - name: Prep toolchain (macOS)
        if: matrix.os == 'macos-14'
        shell: bash
        run: |
          set -euo pipefail

          # Find a macOS 14 SDK (any minor version) so JUCE can keep using
          # APIs removed from the macOS 15 SDK. Prefer an Xcode bundle that
          # ships it and pivot Xcode-select accordingly.
          macosx14_sdk=$(ls -d /Applications/Xcode_*/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX14*.sdk 2>/dev/null | head -n 1 || true)

          if [[ -n "${macosx14_sdk}" ]]; then
            macosx14_dev="$(dirname "$(dirname "${macosx14_sdk}")")"
            echo "Switching to Xcode at ${macosx14_dev} to reach ${macosx14_sdk}"
            sudo xcode-select -s "${macosx14_dev}"
            echo "MACOSX14_SDK=${macosx14_sdk}" >> "$GITHUB_ENV"
          else
            echo "macOS 14 SDK not found even after pinning Xcode 15.4; bail so we don't chew cycles on an impossible build" >&2
            exit 1
          fi

          export HOMEBREW_NO_AUTO_UPDATE=1
          brew install ninja cmake

      - name: Prep toolchain (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          choco install -y ninja cmake

      - name: Configure CMake (Ninja on *nix, Visual Studio on Windows)
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cmake -S plugins -B plugins/build -G "Visual Studio 17 2022" -A x64 \
              -DCMAKE_BUILD_TYPE=Release \
              -DJUCE_VST3_CAN_REPLACE_VST2=0
          else
            cmake_args=(
              -S plugins
              -B plugins/build
              -G Ninja
              -DCMAKE_BUILD_TYPE=Release
              -DJUCE_VST3_CAN_REPLACE_VST2=0
            )

            if [[ "${{ matrix.os }}" == "macos-14" ]]; then
              # Universal (arm64 + x86_64) and pinned to the macOS 14 SDK so
              # JUCE can still reference APIs removed from the 15 SDK.
              # Use an array so the semicolon survives shell parsing and CMake
              # receives a true list (otherwise clang gets a munged
              # "-arch x86_64 -arch arm64" string and bails).
              cmake_args+=("-DCMAKE_OSX_ARCHITECTURES=x86_64;arm64")

              if [[ -n "${MACOSX14_SDK:-}" ]]; then
                cmake_args+=("-DCMAKE_OSX_SYSROOT=${MACOSX14_SDK}")
              else
                echo "No macOS 14 SDK detected; using default sysroot and expecting JUCE to honor older APIs" >&2
              fi
            fi

            echo "Configuring with: ${cmake_args[*]}"
            cmake "${cmake_args[@]}"
          fi
        env:
          # Punk-rock note: VST2 stays disabled; VST3 can NOT replace it.
          JUCE_VST3_CAN_REPLACE_VST2: "0"

      - name: Build
        shell: bash
        run: |
          cmake --build plugins/build --config Release

      # Artifact map (so future debuggers know where the bits live):
      # - macOS: plugins/build/juce-macos-bundle.tar.gz wraps HorizonJuce_artefacts[/Release]
      #           VST3/Horizon.vst3 + Standalone/Horizon.app
      # - Linux: plugins/build/juce-linux-bundle.tar.gz wraps HorizonJuce_artefacts[/Release]
      #          VST3/Horizon.vst3 + Standalone/Horizon
      # - Windows: plugins/build/juce-windows-bundle.zip wraps HorizonJuce_artefacts\Release
      #            VST3/Horizon.vst3 + Standalone/Horizon.exe
      - name: Package JUCE outputs (macOS)
        if: matrix.os == 'macos-14'
        shell: bash
        run: |
          set -euo pipefail
          artefact_root="plugins/build/HorizonJuce_artefacts"
          # Visual Studio-style builds tuck results under Release/; grab the
          # same path here in case the mac runner ever inherits that layout.
          if [ -d "${artefact_root}/Release" ]; then
            artefact_root="${artefact_root}/Release"
          fi

          echo "Packing macOS JUCE outputs from ${artefact_root}" \
            "(VST3 + standalone .app)."
          tar -czf plugins/build/juce-macos-bundle.tar.gz \
            -C "${artefact_root}" \
            VST3/Horizon.vst3 \
            Standalone/Horizon.app

          echo "juce-macos-bundle.tar.gz holds:" \
            "${artefact_root}/VST3/Horizon.vst3 and ${artefact_root}/Standalone/Horizon.app"

      - name: Upload JUCE artifacts (macOS)
        if: matrix.os == 'macos-14'
        uses: actions/upload-artifact@v4
        with:
          name: juce-macos-artefacts
          path: plugins/build/juce-macos-bundle.tar.gz
          if-no-files-found: warn

      - name: Package JUCE outputs (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          set -euo pipefail
          artefact_root="plugins/build/HorizonJuce_artefacts"
          if [ -d "${artefact_root}/Release" ]; then
            artefact_root="${artefact_root}/Release"
          fi

          echo "Bundling Linux JUCE outputs from ${artefact_root}" \
            "(VST3 folder + standalone binary)."
          tar -czf plugins/build/juce-linux-bundle.tar.gz \
            -C "${artefact_root}" \
            VST3/Horizon.vst3 \
            Standalone/Horizon

          echo "juce-linux-bundle.tar.gz holds:" \
            "${artefact_root}/VST3/Horizon.vst3 and ${artefact_root}/Standalone/Horizon"

      - name: Upload JUCE artifacts (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: juce-linux-artefacts
          path: plugins/build/juce-linux-bundle.tar.gz
          if-no-files-found: warn

      - name: Package JUCE outputs (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          $artefactRoot = "plugins/build/HorizonJuce_artefacts"
          if (Test-Path "$artefactRoot/Release") {
            $artefactRoot = "$artefactRoot/Release"
          }

          Write-Host "Zip VST3 + standalone .exe from $artefactRoot"
          $pathsToZip = @(
            "$artefactRoot/VST3/Horizon.vst3",
            "$artefactRoot/Standalone/Horizon.exe"
          )
          Compress-Archive -Path $pathsToZip -DestinationPath "plugins/build/juce-windows-bundle.zip"

          Write-Host "juce-windows-bundle.zip holds:" `
            "$artefactRoot/VST3/Horizon.vst3 and $artefactRoot/Standalone/Horizon.exe"

      - name: Upload JUCE artifacts (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: juce-windows-artefacts
          path: plugins/build/juce-windows-bundle.zip
          if-no-files-found: warn
