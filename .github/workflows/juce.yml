name: JUCE CI

on:
  push:
  pull_request:

jobs:
  build:
    name: JUCE build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # We build "current" macOS (arm64) here; true legacy Macs stay on internal machines.
        os: [ubuntu-latest, windows-latest, macos-14]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clear any pre-checked-in build cache
        shell: bash
        run: cmake -E rm -rf plugins/build

      - name: Prep toolchain (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ninja-build \
            cmake \
            pkg-config \
            libasound2-dev \
            libcurl4-openssl-dev \
            libfreetype6-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libx11-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev

      - name: Prep toolchain (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          choco install -y ninja cmake

      - name: Prep toolchain (macOS)
        if: matrix.os == 'macos-14'
        shell: bash
        run: |
          set -euo pipefail
          # Xcode + Ninja + CMake already live on the runner; tighten up paths for clarity.
          xcode-select -p
          cmake --version
          ninja --version

      - name: Configure CMake (Ninja on *nix, Visual Studio on Windows)
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cmake -S plugins -B plugins/build -G "Visual Studio 17 2022" -A x64 \
              -DCMAKE_BUILD_TYPE=Release \
              -DJUCE_VST3_CAN_REPLACE_VST2=0
          elif [[ "${{ matrix.os }}" == "macos-14" ]]; then
            cmake_args=(
              -S plugins
              -B plugins/build
              -G Ninja
              -DCMAKE_BUILD_TYPE=Release
              -DJUCE_VST3_CAN_REPLACE_VST2=0
              -DCMAKE_OSX_ARCHITECTURES=arm64
            )

            echo "Configuring macOS build with: ${cmake_args[*]}"
            cmake "${cmake_args[@]}"
          else
            cmake_args=(
              -S plugins
              -B plugins/build
              -G Ninja
              -DCMAKE_BUILD_TYPE=Release
              -DJUCE_VST3_CAN_REPLACE_VST2=0
            )

            echo "Configuring with: ${cmake_args[*]}"
            cmake "${cmake_args[@]}"
          fi
        env:
          # Punk-rock note: VST2 stays disabled; VST3 can NOT replace it.
          JUCE_VST3_CAN_REPLACE_VST2: "0"

      - name: Build
        shell: bash
        run: |
          cmake --build plugins/build --config Release

      # Artifact map (so future debuggers know where the bits live):
      # - Linux: plugins/build/juce-linux-bundle.tar.gz wraps HorizonJuce_artefacts[/Release]
      #          VST3/Horizon.vst3 + Standalone/Horizon
      # - Windows: plugins/build/juce-windows-bundle.zip wraps HorizonJuce_artefacts\Release
      #            VST3/Horizon.vst3 + Standalone/Horizon.exe
      # - macOS: plugins/build/juce-macos-bundle.tar.gz wraps HorizonJuce_artefacts[/Release]
      #          VST3/Horizon.vst3 + Standalone/Horizon.app

      - name: Package JUCE outputs (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          set -euo pipefail
          artefact_root="plugins/build/HorizonJuce_artefacts"
          if [ -d "${artefact_root}/Release" ]; then
            artefact_root="${artefact_root}/Release"
          fi

          echo "Bundling Linux JUCE outputs from ${artefact_root}" \
            "(VST3 folder + standalone binary)."
          tar -czf plugins/build/juce-linux-bundle.tar.gz \
            -C "${artefact_root}" \
            VST3/Horizon.vst3 \
            Standalone/Horizon

          echo "juce-linux-bundle.tar.gz holds:" \
            "${artefact_root}/VST3/Horizon.vst3 and ${artefact_root}/Standalone/Horizon"

      - name: Upload JUCE artifacts (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: juce-linux-artefacts
          path: plugins/build/juce-linux-bundle.tar.gz
          if-no-files-found: error

      - name: Package JUCE outputs (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          $artefactRoot = "plugins/build/HorizonJuce_artefacts"
          if (Test-Path "$artefactRoot/Release") {
            $artefactRoot = "$artefactRoot/Release"
          }

          Write-Host "Zip VST3 + standalone .exe from $artefactRoot"
          $pathsToZip = @(
            "$artefactRoot/VST3/Horizon.vst3",
            "$artefactRoot/Standalone/Horizon.exe"
          )
          Compress-Archive -Path $pathsToZip -DestinationPath "plugins/build/juce-windows-bundle.zip"

          Write-Host "juce-windows-bundle.zip holds:" `
            "$artefactRoot/VST3/Horizon.vst3 and $artefactRoot/Standalone/Horizon.exe"

      - name: Upload JUCE artifacts (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: juce-windows-artefacts
          path: plugins/build/juce-windows-bundle.zip
          if-no-files-found: error

      - name: Package JUCE outputs (macOS)
        if: matrix.os == 'macos-14'
        shell: bash
        run: |
          set -euo pipefail
          artefact_root="plugins/build/HorizonJuce_artefacts"
          if [ -d "${artefact_root}/Release" ]; then
            artefact_root="${artefact_root}/Release"
          fi

          echo "Bundling macOS JUCE outputs from ${artefact_root}" \
            "(VST3 bundle + standalone .app)."
          tar -czf plugins/build/juce-macos-bundle.tar.gz \
            -C "${artefact_root}" \
            VST3/Horizon.vst3 \
            Standalone/Horizon.app

          echo "juce-macos-bundle.tar.gz holds:" \
            "${artefact_root}/VST3/Horizon.vst3 and ${artefact_root}/Standalone/Horizon.app"

      - name: Upload JUCE artifacts (macOS)
        if: matrix.os == 'macos-14'
        uses: actions/upload-artifact@v4
        with:
          name: juce-macos-artefacts
          path: plugins/build/juce-macos-bundle.tar.gz
          if-no-files-found: error
