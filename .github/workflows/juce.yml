name: JUCE CI

on:
  push:
  pull_request:

jobs:
  build:
    name: JUCE build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # macOS-13 images are headed for retirement; swing to macos-15-intel so
        # JUCE still finds the legacy SDK bits it wants while we track upstream
        # fixes for newer APIs. Aim for a universal Mac build (arm64 + x86_64)
        # while we are here.
        os: [ubuntu-latest, macos-15-intel, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clear any pre-checked-in build cache
        shell: bash
        run: cmake -E rm -rf plugins/build

      - name: Prep toolchain (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ninja-build \
            cmake \
            pkg-config \
            libasound2-dev \
            libcurl4-openssl-dev \
            libfreetype6-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libx11-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev

      - name: Prep toolchain (macOS)
        if: matrix.os == 'macos-15-intel'
        shell: bash
        run: |
          # macOS runners install Xcode 15.4 at /Applications/Xcode_15.4.app,
          # but the image occasionally ships without that version. Pick it when
          # present, otherwise stay on the pre-selected toolchain instead of
          # face-planting.
          if [ -d /Applications/Xcode_15.4.app/Contents/Developer ]; then
            sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
          else
            echo "Xcode 15.4 missing; keeping default $(xcode-select -p)"
          fi

          # Force the macOS 14 SDK if available so JUCE steers clear of
          # APIs yanked from the macOS 15 SDK (CGWindowListCreateImage, etc.).
          if xcrun --sdk macosx14 --show-sdk-path >/dev/null 2>&1; then
            echo "Using macOS 14 SDK via CMAKE_OSX_SYSROOT"
          else
            echo "macOS 14 SDK unavailable; the build may trip on macOS 15 SDK removals" >&2
          fi
          export HOMEBREW_NO_AUTO_UPDATE=1
          brew install ninja cmake

      - name: Prep toolchain (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          choco install -y ninja cmake

      - name: Configure CMake (Ninja on *nix, Visual Studio on Windows)
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cmake -S plugins -B plugins/build -G "Visual Studio 17 2022" -A x64 \
              -DCMAKE_BUILD_TYPE=Release \
              -DJUCE_VST3_CAN_REPLACE_VST2=0
          else
            cmake_extra=""
            if [[ "${{ matrix.os }}" == "macos-15-intel" ]]; then
              # Universal (arm64 + x86_64) and pinned to the macOS 14 SDK so
              # JUCE can still reference APIs removed from the 15 SDK.
              macos_sysroot=$(xcrun --sdk macosx14 --show-sdk-path 2>/dev/null || true)
              cmake_extra="-DCMAKE_OSX_ARCHITECTURES=\"x86_64;arm64\""
              if [[ -n "${macos_sysroot}" ]]; then
                cmake_extra="${cmake_extra} -DCMAKE_OSX_SYSROOT=${macos_sysroot}"
              fi
            fi

            cmake -S plugins -B plugins/build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DJUCE_VST3_CAN_REPLACE_VST2=0 \
              ${cmake_extra}
          fi
        env:
          # Punk-rock note: VST2 stays disabled; VST3 can NOT replace it.
          JUCE_VST3_CAN_REPLACE_VST2: "0"

      - name: Build
        shell: bash
        run: |
          cmake --build plugins/build --config Release

      # Artifact map (so future debuggers know where the bits live):
      # - macOS: plugins/build/juce-macos-bundle.tar.gz wraps HorizonJuce_artefacts[/Release]
      #           VST3/Horizon.vst3 + Standalone/Horizon.app
      # - Linux: plugins/build/juce-linux-bundle.tar.gz wraps HorizonJuce_artefacts[/Release]
      #          VST3/Horizon.vst3 + Standalone/Horizon
      # - Windows: plugins/build/juce-windows-bundle.zip wraps HorizonJuce_artefacts\Release
      #            VST3/Horizon.vst3 + Standalone/Horizon.exe
      - name: Package JUCE outputs (macOS)
        if: matrix.os == 'macos-15-intel'
        shell: bash
        run: |
          set -euo pipefail
          artefact_root="plugins/build/HorizonJuce_artefacts"
          # Visual Studio-style builds tuck results under Release/; grab the
          # same path here in case the mac runner ever inherits that layout.
          if [ -d "${artefact_root}/Release" ]; then
            artefact_root="${artefact_root}/Release"
          fi

          echo "Packing macOS JUCE outputs from ${artefact_root}" \
            "(VST3 + standalone .app)."
          tar -czf plugins/build/juce-macos-bundle.tar.gz \
            -C "${artefact_root}" \
            VST3/Horizon.vst3 \
            Standalone/Horizon.app

          echo "juce-macos-bundle.tar.gz holds:" \
            "${artefact_root}/VST3/Horizon.vst3 and ${artefact_root}/Standalone/Horizon.app"

      - name: Upload JUCE artifacts (macOS)
        if: matrix.os == 'macos-15-intel'
        uses: actions/upload-artifact@v4
        with:
          name: juce-macos-artefacts
          path: plugins/build/juce-macos-bundle.tar.gz
          if-no-files-found: warn

      - name: Package JUCE outputs (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          set -euo pipefail
          artefact_root="plugins/build/HorizonJuce_artefacts"
          if [ -d "${artefact_root}/Release" ]; then
            artefact_root="${artefact_root}/Release"
          fi

          echo "Bundling Linux JUCE outputs from ${artefact_root}" \
            "(VST3 folder + standalone binary)."
          tar -czf plugins/build/juce-linux-bundle.tar.gz \
            -C "${artefact_root}" \
            VST3/Horizon.vst3 \
            Standalone/Horizon

          echo "juce-linux-bundle.tar.gz holds:" \
            "${artefact_root}/VST3/Horizon.vst3 and ${artefact_root}/Standalone/Horizon"

      - name: Upload JUCE artifacts (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: juce-linux-artefacts
          path: plugins/build/juce-linux-bundle.tar.gz
          if-no-files-found: warn

      - name: Package JUCE outputs (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          $artefactRoot = "plugins/build/HorizonJuce_artefacts"
          if (Test-Path "$artefactRoot/Release") {
            $artefactRoot = "$artefactRoot/Release"
          }

          Write-Host "Zip VST3 + standalone .exe from $artefactRoot"
          $pathsToZip = @(
            "$artefactRoot/VST3/Horizon.vst3",
            "$artefactRoot/Standalone/Horizon.exe"
          )
          Compress-Archive -Path $pathsToZip -DestinationPath "plugins/build/juce-windows-bundle.zip"

          Write-Host "juce-windows-bundle.zip holds:" `
            "$artefactRoot/VST3/Horizon.vst3 and $artefactRoot/Standalone/Horizon.exe"

      - name: Upload JUCE artifacts (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: juce-windows-artefacts
          path: plugins/build/juce-windows-bundle.zip
          if-no-files-found: warn
