name: JUCE CI

on:
  push:
  pull_request:

jobs:
  build:
    name: JUCE build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # macOS-13 images are headed for retirement; target macos-15 (Apple
        # silicon) and pin a modern Xcode 16 so we stop fighting vanishing SDK
        # paths while still shipping a universal build (arm64 + x86_64) for
        # Intel holdouts.
        os: [ubuntu-latest, macos-15, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clear any pre-checked-in build cache
        shell: bash
        run: cmake -E rm -rf plugins/build

      # macOS runners ship multiple Xcodes. Force Xcode 16 so we get a recent
      # SDK without the broken Xcode 15.* paths that have been biting us.
      - name: Pin Xcode (macOS)
        if: matrix.os == 'macos-15'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4"

      - name: Prep toolchain (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ninja-build \
            cmake \
            pkg-config \
            libasound2-dev \
            libcurl4-openssl-dev \
            libfreetype6-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libx11-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev

      - name: Prep toolchain (macOS)
        if: matrix.os == 'macos-15'
        shell: bash
        run: |
          set -euo pipefail

          sdk_path=$(xcrun --sdk macosx --show-sdk-path)
          dev_dir=$(xcode-select --print-path)
          echo "Rolling with Xcode at ${dev_dir} using SDK ${sdk_path} (expecting Xcode 16.x)"
          echo "MACOSX_SDK=${sdk_path}" >> "$GITHUB_ENV"

          export HOMEBREW_NO_AUTO_UPDATE=1
          brew install ninja cmake

      - name: Prep toolchain (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          choco install -y ninja cmake

      - name: Configure CMake (Ninja on *nix, Visual Studio on Windows)
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cmake -S plugins -B plugins/build -G "Visual Studio 17 2022" -A x64 \
              -DCMAKE_BUILD_TYPE=Release \
              -DJUCE_VST3_CAN_REPLACE_VST2=0
          else
            cmake_args=(
              -S plugins
              -B plugins/build
              -G Ninja
              -DCMAKE_BUILD_TYPE=Release
              -DJUCE_VST3_CAN_REPLACE_VST2=0
            )

            if [[ "${{ matrix.os }}" == "macos-15" ]]; then
              # Universal (arm64 + x86_64) and pinned to the default SDK that
              # ships with Xcode 16. Use an array so the semicolon survives
              # shell parsing and CMake receives a true list (otherwise clang
              # gets a munged "-arch x86_64 -arch arm64" string and bails).
              cmake_args+=("-DCMAKE_OSX_ARCHITECTURES=x86_64;arm64")
              cmake_args+=("-DCMAKE_OSX_SYSROOT=${MACOSX_SDK}")
            fi

            echo "Configuring with: ${cmake_args[*]}"
            cmake "${cmake_args[@]}"
          fi
        env:
          # Punk-rock note: VST2 stays disabled; VST3 can NOT replace it.
          JUCE_VST3_CAN_REPLACE_VST2: "0"

      - name: Build
        shell: bash
        run: |
          cmake --build plugins/build --config Release

      # Artifact map (so future debuggers know where the bits live):
      # - macOS: plugins/build/juce-macos-bundle.tar.gz wraps HorizonJuce_artefacts[/Release]
      #           VST3/Horizon.vst3 + Standalone/Horizon.app
      # - Linux: plugins/build/juce-linux-bundle.tar.gz wraps HorizonJuce_artefacts[/Release]
      #          VST3/Horizon.vst3 + Standalone/Horizon
      # - Windows: plugins/build/juce-windows-bundle.zip wraps HorizonJuce_artefacts\Release
      #            VST3/Horizon.vst3 + Standalone/Horizon.exe
      - name: Package JUCE outputs (macOS)
        if: matrix.os == 'macos-15'
        shell: bash
        run: |
          set -euo pipefail
          artefact_root="plugins/build/HorizonJuce_artefacts"
          # Visual Studio-style builds tuck results under Release/; grab the
          # same path here in case the mac runner ever inherits that layout.
          if [ -d "${artefact_root}/Release" ]; then
            artefact_root="${artefact_root}/Release"
          fi

          echo "Packing macOS JUCE outputs from ${artefact_root}" \
            "(VST3 + standalone .app)."
          tar -czf plugins/build/juce-macos-bundle.tar.gz \
            -C "${artefact_root}" \
            VST3/Horizon.vst3 \
            Standalone/Horizon.app

          echo "juce-macos-bundle.tar.gz holds:" \
            "${artefact_root}/VST3/Horizon.vst3 and ${artefact_root}/Standalone/Horizon.app"

      - name: Upload JUCE artifacts (macOS)
        if: matrix.os == 'macos-15'
        uses: actions/upload-artifact@v4
        with:
          name: juce-macos-artefacts
          path: plugins/build/juce-macos-bundle.tar.gz
          if-no-files-found: warn

      - name: Package JUCE outputs (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          set -euo pipefail
          artefact_root="plugins/build/HorizonJuce_artefacts"
          if [ -d "${artefact_root}/Release" ]; then
            artefact_root="${artefact_root}/Release"
          fi

          echo "Bundling Linux JUCE outputs from ${artefact_root}" \
            "(VST3 folder + standalone binary)."
          tar -czf plugins/build/juce-linux-bundle.tar.gz \
            -C "${artefact_root}" \
            VST3/Horizon.vst3 \
            Standalone/Horizon

          echo "juce-linux-bundle.tar.gz holds:" \
            "${artefact_root}/VST3/Horizon.vst3 and ${artefact_root}/Standalone/Horizon"

      - name: Upload JUCE artifacts (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: juce-linux-artefacts
          path: plugins/build/juce-linux-bundle.tar.gz
          if-no-files-found: warn

      - name: Package JUCE outputs (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          $artefactRoot = "plugins/build/HorizonJuce_artefacts"
          if (Test-Path "$artefactRoot/Release") {
            $artefactRoot = "$artefactRoot/Release"
          }

          Write-Host "Zip VST3 + standalone .exe from $artefactRoot"
          $pathsToZip = @(
            "$artefactRoot/VST3/Horizon.vst3",
            "$artefactRoot/Standalone/Horizon.exe"
          )
          Compress-Archive -Path $pathsToZip -DestinationPath "plugins/build/juce-windows-bundle.zip"

          Write-Host "juce-windows-bundle.zip holds:" `
            "$artefactRoot/VST3/Horizon.vst3 and $artefactRoot/Standalone/Horizon.exe"

      - name: Upload JUCE artifacts (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: juce-windows-artefacts
          path: plugins/build/juce-windows-bundle.zip
          if-no-files-found: warn
